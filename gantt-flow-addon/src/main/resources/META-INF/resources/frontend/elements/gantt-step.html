<dom-module id="gantt-step">

	<template strip-whitespace>
		<style>
			:host {
				--gantt-step-left: 0px;
				--gantt-step-width: 0px;
				--gantt-step-background-color: #000;

				position: absolute;
				height: 30px;
				z-index: 1;
				-webkit-touch-callout: none;
				touch-action: pan-y;
				-ms-touch-action: pan-y;
				-webkit-border-radius: 3px;
			  -moz-border-radius: 3px;
			  border-radius: 3px;
			  -webkit-box-shadow: 2px 0 3px rgba(0, 0, 0, 0.14), 0 0 0 1px rgba(0, 0, 0, 0.07);
			  -moz-box-shadow: 2px 0 3px rgba(0, 0, 0, 0.14), 0 0 0 1px rgba(0, 0, 0, 0.07);
			  box-shadow: 2px 0 3px rgba(0, 0, 0, 0.14), 0 0 0 1px rgba(0, 0, 0, 0.07);
				background-color: var(--gantt-step-background-color);
				left: var(--gantt-step-left);
				width: var(--gantt-step-width);
			}

			:host(.has-sub-steps:hover) > .bar-label {
				width: 100%;
				padding-left: 3px;
				background-color: rgba(246, 255, 99, 0.3);
				-webkit-border-radius: 6px;
				-moz-border-radius: 6px;
				border-radius: 6px;
				transform: translate(0,-27px);
				-webkit-transform: translate(0,-27px);
				-o-transform: translate(0,-27px);
				-moz-transform: translate(0,-27px);
			}
			:host(.has-sub-steps:hover) > .bar-label:hover {
				cursor: move;
			}
			:host(.has-sub-steps:hover) > .bar-label:hover ~ .bar-progress {
				display: block;
			}
			:host(.has-sub-steps) {
				background-color: rgba(246, 255, 99, 0.3) !important;
			}
			:host(.has-sub-steps) > .bar-label {
				position: absolute;
				max-width: 100%;
			}
			:host(.has-sub-steps) > .bar-progress {
				z-index: 2;
				bottom: 0;
				display: none;
			}

			.bar-label {
				text-overflow: ellipsis;
				white-space: nowrap;
				overflow: hidden;
				margin: 3px;
			}

			.bar-progress {
				position: absolute;
				bottom: 0;
				display: block;
				width: 100%;
				overflow: hidden;
			}

			.v-progressbar-wrapper,
			.v-progressbar-indicator {
				min-width: auto;
			}

			:host(.bar.moving) {
				background: orange;
				cursor: move;
				z-index: 3;
			}

			:host(.bar.resizing) {
				background: orange;
				cursor: e-resize;
				z-index: 3;
			}

			:host(.bar.invalid) {
				visibility: hidden;
			}

			/* Bar elements on selection mode.
		 	Highlight hovered bar elements */
			:host(.select-target-step) {
				touch-action: none;
				-ms-touch-action: none;
			}
			:host(.select-target-step.bar:hover) {
				background: orange !important;
			}
		</style>
		<div id="barLabel" class="bar-label">[[caption]]</div>
	</template>

	<script>
		class GanttStep extends Polymer.Element {
			static get is() { return 'gantt-step'; }

			static get properties() {
				return {
					ganttElement: Object,
					step: Object,
					caption: String,
					description: String,
					showProgress: Boolean,
					styleName: String,
					backgroundColor: {
						type: String,
						value: "#A8D9FF",
						observer: '_onBackgroundColorChanged',
					},
					progress: {
						type: Number,
						value: 0.0,
					},
					resizable: {
						type: Boolean,
						value: true,
					},
					movable: {
						type: Boolean,
						value: true,
					},
					startDate: {
						type: Number,
						value: -1,
					},
					endDate: {
						type: Number,
						value: -1,
					}
				};
			}

			static get observers() {
			  return [
			    'datesChanged(startDate, endDate)'
			  ]
			}

			datesChanged(start, end) {
				this.updateStyles({
          '--gantt-step-left': this.calculateLeftPosition(start, end),
					'--gantt-step-width': this.calculateWidth(start, end),
        });
			}

			_onBackgroundColorChanged(backgroundColor) {
				this.updateStyles({
          '--gantt-step-background-color': backgroundColor,
        });
			}

			connectedCallback() {
				super.connectedCallback();
				var initial = !this.readyAndConnected;
				this.readyAndConnected = true;

				if(initial) {
					this.dispatchEvent(new CustomEvent('register-step', {bubbles: true, composed: true, detail: {stepElement: this, step: this.step}}));
				}
			}

			registerPositionCalculator(f) {
				this.positionCalculator = f;
			}
			registerWidthCalculator(f) {
				this.widthCalculator = f;
			}
			calculateLeftPosition(start, end) {
				if(!this.positionCalculator)
					return "0px";
				return this.positionCalculator([start, end]);
			}
			calculateWidth(start, end) {
				if(!this.widthCalculator)
					return "0px";
				return this.widthCalculator([start, end]);
			}
		}
		customElements.define(GanttStep.is, GanttStep);
	</script>
</dom-module>
