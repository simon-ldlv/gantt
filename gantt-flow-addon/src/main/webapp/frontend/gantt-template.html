
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="gantt-lib.html">
<link rel="import" href="gantt-widget.html">

<dom-module id="gantt-template">
    <template>
    	<slot></slot>
    </template>

    <script>
        class GanttTemplate extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element) {
            static get is() {
                return 'gantt-template'
            }

            constructor() {
      				super();
      				window.addEventListener('gantt-ready', e => this._onGanttReady(e));
      			}

            static get observers() {
      			  return [
                '_stepPropertiesChanged(steps.*)',
                '_subStepPropertiesChanged(subSteps.*)',
                '_heightChanged(height)',
      			  ]
      			}

            connectedCallback() {
              super.connectedCallback();
              this.addEventListener('iron-resize', this._onIronResize.bind(this));
            }

            _heightChanged(height) {
              let g = this.firstChild.ganttElement;
              if(g) {
                g.height = this.height;
                g.notifySizeChanged();
              }
            }

            _onIronResize() {
              console.log('Size changed to ' + this.offsetWidth + "x" + this.offsetHeight);
              let g = this.firstChild.ganttElement;
              if(g) {
                  g.notifySizeChanged();
              }
            }

           	_ganttStateChanged(resolution,startDate,endDate,locale,timeZoneId) {
            	this.firstChild.ganttElement.setState(this.settings);
           	};

            _stepPropertiesChanged(allChanges) {
              let g = this.firstChild.ganttElement;
              if (allChanges.path && g && allChanges) {
                let arr = allChanges.path.split(".");
                if(arr[0] === "steps") {
                  if(arr.length == 2 && "splices" === arr[1]) {
                    this._stepsChanged(allChanges.value);
                  } else if(arr.length == 3 && !isNaN(arr[1])) {
                    this._stepChanged(allChanges.base[arr[1]]);
                  }
                }
              }
            }

            _subStepPropertiesChanged(allChanges) {
              let g = this.firstChild.ganttElement;
              if (allChanges.path && g && allChanges) {
                let arr = allChanges.path.split(".");
                if(arr[0] === "subSteps") {
                  if(arr.length == 2 && "splices" === arr[1]) {
                    this._subStepsChanged(allChanges.value);
                  } else if(arr.length == 3 && !isNaN(arr[1])) {
                    this._subStepChanged(allChanges.base[arr[1]]);
                  }
                }
              }
            }

            _stepsChanged(changeRecord) {
              let g = this.firstChild.ganttElement;
              if (g && changeRecord) {
                changeRecord.indexSplices.forEach(function(s) {
      		        s.removed.forEach(function(step) {
                      g.removeStep(step);
      		          console.log(step.caption + ' was removed');
      		        });
      		        for (let i=0; i<s.addedCount; i++) {
      		          let index = s.index + i;
      		          let step = s.object[index];
                    g.addStep(step, index);
      		          console.log('Step ' + step.caption + ' was added');
      		        }
      		      }, this);
                g.updateAllStepsPredecessors();
              }
            }

      			_subStepsChanged(changeRecord) {
              let ganttTemplate = this;
              let g = ganttTemplate.firstChild.ganttElement;

      				if (g && changeRecord) {
      					let updatedSteps = new Set();
      		      changeRecord.indexSplices.forEach(function(s) {
      		        s.removed.forEach(function(substep) {
      							let step = g.getStepByUid(substep.owner.uid);
      							updatedSteps.add(step);
                    ganttTemplate._removeSubStepFromStep(step, substep);
      		          console.log(substep.caption + ' substep was removed');
      		        });
      		        for (let i=0; i<s.addedCount; i++) {
      		          let index = s.index + i;
      		          let newSubStep = s.object[index];
      							let step = g.getStepByUid(newSubStep.owner.uid);
      							updatedSteps.add(step);
                    step.subSteps.push(newSubStep);
      		          console.log('SubStep ' + newSubStep.caption + ' added');
      		        }
      		      }, this);

                updatedSteps.forEach(function(step) {
                   g.updateStep(step);
                });
      		    }
      			}
			
     		refreshStep(uid) {
     			let g = this.firstChild.ganttElement;
	   			let step = g.getStepByUid(uid);
	   			if(!step) return;
	   			this._fillStepWithSubSteps(step);
	   			g.updateStep(step);
			}
			
            _stepChanged(step) {
              let g = this.firstChild.ganttElement;
              this._fillStepWithSubSteps(step);
              g.updateStep(step);
            }

            _subStepChanged(subStep) {
              let g = this.firstChild.ganttElement;
              let step = g.getStepByUid(subStep.owner.uid);
              if(!step) return;
              if(!this._containsSubStep(step, subStep)) {
                step.subSteps.push(subStep);
                console.log('SubStep ' + subStep.caption + ' added/moved');
              }
              g.updateSubStep(subStep);
            }

            _containsSubStep(step, subStep) {
              for (let i = 0; i < this._getSubSteps(step).length; i++) {
                 if (step.subSteps[i].uid === subStep.uid) {
                   return true;
                 }
              }
              return false;
            }

            _removeSubStepFromStep(step, subStep) {
              for (let i = 0; i < this._getSubSteps(step).length; i++) {
                 if (step.subSteps[i].uid === subStep.uid) {
                   step.subSteps.splice(i, 1);
                   return;
                 }
              }
            }

            _fillStepWithSubSteps(step) {
              step.subSteps = [];
              for (let i=0; i<this.subSteps.length; i++) {
                let subStep = this.subSteps[i];
                if(subStep.owner.uid === step.uid) {
                  step.subSteps.push(subStep);
                }
              }
            }

            _getSubSteps(step) {
              if(!step.subSteps) {
                step.subSteps = [];
              }
              return step.subSteps;
            }

            _onGanttReady(e) {
            	this.firstChild.ganttElement = new gantt.GanttElement(this.firstChild);

              let ganttTemplate = this;

      				// set data
      				let g = this.firstChild.ganttElement;

              g.height = this.height;

      				if(this.settings) {
      					g.setState(this.settings);
      				}

              // fill steps with substeps (because PolymerTemplate does not support 'steps.subSteps')
              for (let i=0; i<this.steps.length; i++) {
                let step = this.steps[i];
                step.subSteps = [];
                this._fillStepWithSubSteps(step);
              }

      				g.getGanttElement().steps = this.steps;

      				// step click handling
      				g.getGanttElement().handleStepClicked = function(stepUid, details) {
      					var step = g.getStepByUid(stepUid);
                if(step.substep) {
                  ganttTemplate.$server.handleSubStepClicked(stepUid, details);
                } else {
                  ganttTemplate.$server.handleStepClicked(stepUid, details);
                }
      				}

      				// step move handling
      				g.getGanttElement().handleOnMove = function(stepUid, newStepUid, startDate, endDate, details) {
                ganttTemplate.$server.handleOnMove(stepUid, newStepUid, startDate, endDate, details);
      				}

      				// step resize handling
      				g.getGanttElement().handleOnResize = function(stepUid, startDate, endDate, details) {
      					var step = g.getStepByUid(stepUid);
      					step.startDate = startDate;
      					step.endDate = endDate;
      					g.update(step);
                ganttTemplate.$server.handleOnResize(stepUid, startDate, endDate, details);
      				}

      				// step predecessor change handling
      				g.getGanttElement().handleOnPredecessorChange = function(newPredecessorStepUid, forTargetStepUid, clearPredecessorForStepUid) {
                ganttTemplate.$server.handleOnPredecessorChange(newPredecessorStepUid, forTargetStepUid, clearPredecessorForStepUid);
      				}

      				// register observer for state changes to delegate new state to gantt
      				this._createMethodObserver('_ganttStateChanged(settings.resolution,settings.startDate,settings.endDate,settings.locale,settings.timeZoneId,settings.movableStepsBetweenRows)', true);
    			   }
        }
        customElements.define(GanttTemplate.is, GanttTemplate);
    </script>
</dom-module>
